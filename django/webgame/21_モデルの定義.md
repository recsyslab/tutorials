# モデルの定義

スコア管理に必要なデータをモデルクラスとして定義していきます．モデルクラスは，`webgame/touch/models.py`に記述します．ここでは，スコア管理に必要なスコアテーブルを下記のように設計することにします．

| カラム名 | 説明 | データ型 | 制約 |
| --- | --- | --- | --- |
| id | スコアID | INT	PRIMARY KEY |
| player_name | プレイヤ名 | VARCHAR(20)	NOT NULL |
| score | スコア | INT | NOT NULL |
| achieved_at | 達成日時 | TIMESTAMP | NOT NULL |

以上を基に，モデルクラスを定義します．`webgame/touch/models.py`に以下のコードを記述してください．

リスト1: `webgame/touch/models.py`
```py
from django.db import models


class Score(models.Model):
    """スコアモデル"""
    player_name = models.CharField(verbose_name='プレイヤ名', max_length=20)
    score = models.IntegerField(verbose_name='スコア')
    achieved_at = models.DateTimeField(verbose_name='達成日時', auto_now_add=True)

    class Meta:
        verbose_name_plural = 'スコア'

    def __str__(self):
        return str(self.player_name + ":" + str(self.score))
```

`webgame/touch/models.py`では`django.db.models.Model`クラスを継承したスコアモデル`Score`を定義しています．

テーブルのカラムはモデルクラスのクラス属性として定義します．例えば，`Score`クラスには`player_name`を定義しています．このクラス属性は`Field`クラスのインスタンスとして定義します．`CharField`は文字フィールドを表します．`Field`クラスの`verbose_name`にはそのフィールドの説明を表す人間可読なフィールド名を指定します．また，`CharField`には`max_length`を指定する必要があります．これは，このカラムに登録できる最大文字数を表します．

なお，テーブル設計時には主キーとして`id`を用意していましたが，`Score`クラスでは主キーに対応する属性を定義していません．主キー属性の定義を省略すると，自動t系に`id`というカラム名で主キーが追加されます．


モデルについては，文献[1][2]を参照してください．


モデルの準備ができましたので，マイグレーションを実行します．まず，以下のコマンドでマイグレーションファイルを作成します．

```bash
$ python manage.py makemigrations touch
Migrations for 'touch':
  touch/migrations/0001_initial.py
    - Create model Score
```

`webgame/touch/migrations/`ディレクトリに`0001_initial.py`が作成されました．この時点ではまだマイグレーションは実行されていません．マイグレーションを実行することで，このマイグレーションファイルの内容がデータベースに適用されることになります．以下のコマンドでマイグレーションが実行する内容を確認してみましょう．

```bash
$ python manage.py sqlmigrate touch 0001
BEGIN;
--
-- Create model Score
--
CREATE TABLE "touch_score" ("id" serial NOT NULL PRIMARY KEY, "player_name" varchar(20) NOT NULL, "score" integer NOT NULL, "achieved_at" timestamp with time zone NOT NULL);
COMMIT;
```

このようにSQLが出力されました．マイグレーションはこのSQLを実行するということになります．では，マイグレーションを実行してみましょう．

```bash
$ python manage.py migrate
Operations to perform:
  Apply all migrations: admin, auth, contenttypes, sessions, touch
Running migrations:
  Applying touch.0001_initial... OK
```

PostgreSQL上で，テーブルを確認してください．
 
```pgsql
webgame=# \dt
                     リレーション一覧
 スキーマ |            名前            |    型    | 所有者 
----------+----------------------------+----------+--------
...（略）...
 public   | touch_score                | テーブル | 【ユーザ名】
(11 行)
```

`touch_score`テーブルが作成されていることが確認できます．このように，テーブル名には自動的に「<アプリケーション名>_<モデルのクラス名>」が付けられます．もし，好きなテーブル名を設定したい場合には，リスト1のモデルクラス内の`Meta`クラスに`db_table`属性を指定します．

テーブルの定義も確認してみましょう．

```pgsql
webgame=# \d touch_score
                                        テーブル "public.touch_score"
     列      |            型            | 照合順序 | Null 値を許容 |               デフォルト                
-------------+--------------------------+----------+---------------+-----------------------------------------
 id          | integer                  |          | not null      | nextval('touch_score_id_seq'::regclass)
 player_name | character varying(20)    |          | not null      | 
 score       | integer                  |          | not null      | 
 achieved_at | timestamp with time zone |          | not null      | 
インデックス:
    "touch_score_pkey" PRIMARY KEY, btree (id)
```

このようにテーブル設計したとおりの列が定義されていることがわかります．

マイグレーションの詳細は文献[3][4]を参照してください．

#### 参考
1. [はじめての Django アプリ作成、その2 | Django ドキュメント | Django # モデルの作成](https://docs.djangoproject.com/ja/3.2/intro/tutorial02/#creating-models)
1. 現場で使える Django の教科書《基礎編》 # 第6章 モデル (Model)
1. 現場で使える Django の教科書《基礎編》 # 第11章 データベースのマイグレーション (Model)
