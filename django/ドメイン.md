# ドメイン

## ドメインの取得
1. ConoHaコントロールパネルを開く。
   1. **ドメイン > ドメイン**をクリックする。
   2. **ドメイン取得**ボタンをクリックする。
   3. ドメイン名に希望のドメイン名を入力し検索する。
   4. 希望のドメイン名を選択し、**カートに追加**ボタンをクリックする。
   5. 支払処理にすすむ。

## ドメインの設定
1. ConoHaコントロールパネルを開く。
   1. **DNS**をクリックする。
      1. **+ドメイン**ボタンをクリックする。
      2. 取得したドメイン名を入力し、**保存**ボタンをクリックする。
      3. **ドメインリスト**にドメインが追加される。
      4. ドメイン名の部分をクリックすると、DNSレコード一覧が表示される。
      5. **編集**アイコンをクリックする。
      6. 下記のように設定する。
         - `A, @, 3600, ＊＊＊.＊＊＊.＊＊＊.＊＊＊`（サーバーのIPアドレス）
         - `A, www, 3600, ＊＊＊.＊＊＊.＊＊＊.＊＊＊`
         - `A, rsl000, 3600, ＊＊＊.＊＊＊.＊＊＊.＊＊＊`
         - `CNAME, ftp, 3600, ＊＊＊.＊＊＊.＊＊＊.＊＊＊`

ドメインの設定が反映されるまで数時間かかる。

下記にアクセスし、「Welcome to nginx!」と表示されればOK
http://www.recsyslab-ex.org/


https://support.conoha.jp/w/adddomain/

DNSを使う｜ConoHa VPSサポート
https://support.conoha.jp/v/dns/


CSRの生成
$ openssl genrsa -aes256 -out ssl_private_key.pem.key 2048
$ openssl req -new -key ssl_private_key.pem.key -out ssl.csr
Enter pass phrase for ssl_private_key.pem.key:
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:JP
State or Province Name (full name) [Some-State]:Shiga
Locality Name (eg, city) []:Otsu
Organization Name (eg, company) [Internet Widgits Pty Ltd]:Ryukoku University
Organizational Unit Name (eg, section) []:
Common Name (e.g. server FQDN or YOUR name) []:www.recsyslab-ex.org
Email Address []:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:


$ cat ssl.csr

SSLの設定

1. ConoHaコントロールパネルを開く。
   1. **セキュリティ - SSL**をクリックする。
   2. **SSL**ボタンをクリックする。
   3. 下記を設定する。
      - プラン: アルファSSL
      - 取得形式: 新規取得
      - 契約期間: 1年
      - デュアルアクセス: 有効
      - 認証方法: DNS認証(推奨)
   4. **次へ**ボタンをクリックする。
   5. CSR貼付欄に生成したCSRをそのまま貼り付ける。
   6. **CSR内容確認**ボタンをクリックする。
   7. CSR解析結果が正常に表示されれば、**次へ**ボタンをクリックする。
   8. 申請担当者情報を入力し、**次へ**ボタンをクリックする。
   9. 申請内容を確認し、**決定**ボタンをクリックする。
   10. 支払確認をし、**決定**ボタンをクリックする。
   11. 認証設定を行うFQDNを選択し、認証先FQDNと認証IDを取得する。
   12. ドメインリストを開き、設定先ドメインで下記のDNSレコードを追加する。
       - TXT, recsyslab-ex.org, 3600, globalsign-domain-verification=830A5DE514885023A94FB61E318A2C5C
       - TXT, www.recsyslab-ex.org, 3600, globalsign-domain-verification=96A0E499159C17DB03B66327B32CB9CE
   13. 設定先ドメインが外部からアクセスできることを確認する。
   14. 各設定先ドメインを選択し、それぞれで**認証依頼**ボタンをクリックする。# 設定が反映されるまでに数時間程度かかる。
   15. 証明書名が表示されれば認証完了。

[Alpha] www.recsyslab-ex.org




認証先FQDN：recsyslab-ex.org
認証ID：globalsign-domain-verification=830A5DE514885023A94FB61E318A2C5C

認証先FQDN：www.recsyslab-ex.org
認証ID：globalsign-domain-verification=96A0E499159C17DB03B66327B32CB9CE



Certbotパッケージのインストール
$ sudo apt install certbot python3-certbot-nginx
$ sudo certbot --nginx -d recsyslab-ex.org -d www.recsyslab-ex.org
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Enter email address (used for urgent renewal and security notices)
 (Enter 'c' to cancel): okukenta@rins.ryukoku.ac.jp

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Please read the Terms of Service at
https://letsencrypt.org/documents/LE-SA-v1.3-September-21-2022.pdf. You must
agree in order to register with the ACME server. Do you agree?
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
(Y)es/(N)o: Y

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Would you be willing, once your first certificate is successfully issued, to
share your email address with the Electronic Frontier Foundation, a founding
partner of the Let's Encrypt project and the non-profit organization that
develops Certbot? We'd like to send you email about our work encrypting the web,
EFF news, campaigns, and ways to support digital freedom.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
(Y)es/(N)o: Y
Account registered.
Requesting a certificate for recsyslab-ex.org and www.recsyslab-ex.org

Successfully received certificate.
Certificate is saved at: /etc/letsencrypt/live/recsyslab-ex.org/fullchain.pem
Key is saved at:         /etc/letsencrypt/live/recsyslab-ex.org/privkey.pem
This certificate expires on 2024-01-07.
These files will be updated when the certificate renews.
Certbot has set up a scheduled task to automatically renew this certificate in the background.

Deploying certificate
Successfully deployed certificate for recsyslab-ex.org to /etc/nginx/sites-enabled/default
Successfully deployed certificate for www.recsyslab-ex.org to /etc/nginx/sites-enabled/default
Congratulations! You have successfully enabled HTTPS on https://recsyslab-ex.org and https://www.recsyslab-ex.org

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
If you like Certbot, please consider supporting our work by:
 * Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
 * Donating to EFF:                    https://eff.org/donate-le
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -


下記にアクセスし、「Welcome to nginx!」と表示されればOK
https://recsyslab-ex.org/
https://www.recsyslab-ex.org/

http://www.recsyslab-ex.org/

SSLを設定すると、wwwにアクセスできなくなった。
Aレコードを設定しなおすとアクセスできた。


参考
nginxでWebサーバーを構築する（Ubuntu編）- マルチドメイン・HTTPS化の設定も解説 - アナグマのモノローグ
https://monologu.com/nginx-ubuntu/
