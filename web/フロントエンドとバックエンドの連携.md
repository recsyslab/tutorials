# フロントエンドとバックエンドの連携

## フロントエンドの実装

### VSCodeの起動
```bash
$ cd ~/dev/app/frontend/
$ code .
```

### hello/page.tsxの作成
`frontend/app/`ディレクトリに`hello`ディレクトリを作成する。
- `~/dev/app/frontend/app/hello/`

作成した`hello/`ディレクトリに`page.tsx`を作成し、下記コードを記述する。

`~/dev/app/frontend/app/hello/page.tsx`
```tsx
export default function Page() {
    return <h1>Hello, Next.js!</h1>
}
```

```bash
$ cd ~/dev/app/frontend/
$ yarn dev
```

ブラウザで http://localhost:3000/hello にアクセスし、「Hello, Next.js」が表示されれば成功。

### Next.js上でのAPIの用意
`frontend/`ディレクトリに`pages/api/`ディレクトリを作成する。
- `~/dev/app/frontend/pages/api/`

作成した`api/`ディレクトリに`hello.ts`を作成し、下記コードを記述する。

`~/dev/app/frontend/pages/api/hello.ts`
```ts
import type { NextApiRequest, NextApiResponse } from 'next'

type Data = {
    name: string
}

export default function handler(
    req: NextApiRequest,
    res: NextApiResponse<Data>
) {
    res.status(200).json({ name: 'John Doe' })
}
```

ブラウザで http://localhost:3000/api/hello にアクセスし、「{"name":"John Doe"}」が表示されれば成功。

※うまく表示されない場合は、サーバを再起動してみる。

### Next.js上でのAPI通信
`frontend/app/`ディレクトリに`hello_frontend_fetch/`ディレクトリを作成する。
- `~/dev/app/frontend/app/hello_frontend_fetch/`

作成した`hello_frontend_fetch/`ディレクトリに`page.tsx`を作成し、下記コードを記述する。

`~/dev/app/frontend/app/hello_frontend_fetch/page.tsx`
```tsx
'use client'

import { useState, useEffect } from 'react'

export default function Page() {
    const [data, setData] = useState({ name: '' })

    useEffect(() => {
        fetch('/api/hello')
            .then((res) => res.json())
            .then((data) => {
                setData(data)
            })

    }, [])
    return <div>hello {data.name}!</div>
}
```

ブラウザで http://localhost:3000/hello_frontend_fetch にアクセスし、「hello John Doe!」が表示されれば成功。

※うまく表示されない場合は、サーバを再起動してみる。

### axiosを使った連携
`frontend/app/`ディレクトリに`hello_frontend/`ディレクトリを作成する。
- `~/dev/app/frontend/app/hello_frontend/`

作成した`hello_frontend/`ディレクトリに`page.tsx`を作成し、下記コードを記述する。

`~/dev/app/frontend/app/hello_frontend/page.tsx`
```tsx
'use client'

import axios from 'axios'
import { useEffect, useState } from 'react'

export default function Page() {
    const [data, setData] = useState({ name: '' })

    useEffect(() => {
        axios.get('/api/hello')
            .then((res) => res.data)
            .then((data) => {
                setData(data)
            })
    }, [])

    return <div>hello {data.name}!</div>
}
```

ブラウザで http://localhost:3000/hello_frontend にアクセスし、「hello John Doe!」が表示されれば成功。

※うまく表示されない場合は、サーバを再起動してみる。

## バックエンドの実装

### VSCodeの起動
```bash
$ cd ~/dev/app/backend/
$ code .
```

### helloアプリケーションの作成
```bash
$ mkdir ~/dev/app/backend/api/
$ cd ~/dev/app/backend/api/
$ source ~/venv/rsl-web/bin/activate
(rsl-web) $ django-admin startapp hello
```

### DjangoでのAPIへのルーティングの設定

`config/urls.py`を下記のように編集する。

`~/dev/app/backend/config/urls.py`
```py
...（略）...
from django.contrib import admin
from django.urls import path, include  # includeを追加

urlpatterns = [
    path("admin/", admin.site.urls),
    path('api/hello/', include('api.hello.urls')),        # 追加
]
```

`api/hello/ursl.py`ディレクトリに`urls.py`を作成し、下記コードを記述する。
`~/dev/app/backend/api/hello/ursl.py`
```py
from django.urls import path
from . import views

urlpatterns = [
    path('backend/', views.Backend.as_view())
]
```

### APIの処理の実装

`api/hello/views.py`を下記のように編集する。

`~/dev/app/backend/api/hello/views.py`
```py
from rest_framework.response import Response
from rest_framework.views import APIView

class Backend(APIView):
    def get(self, request, format=None):
        return Response({"message": "backend"})
```

```bash
(rsl-web) $ cd ~/dev/app/backend/
(rsl-web) $ python manage.py runserver --settings config.settings.development
```

ブラウザで http://localhost:8000/api/hello/backend にアクセスし、バックエンドレスポンスが表示されれば成功。

### フロントエンドからバックエンドのAPIの呼出し

### VSCodeの起動
```bash
$ cd ~/dev/app/frontend/
$ code .
```

### hello_backend/page.tsxの作成
`frontend/app/`ディレクトリに`hello_backend`ディレクトリを作成する。
- `~/dev/app/frontend/app/hello_backend/`

作成した`hello_backend/`ディレクトリに`page.tsx`を作成し、下記コードを記述する。

`~/dev/app/frontend/app/hello_backend/page.tsx`
```tsx
'use client'

import axios from 'axios'
import { useEffect, useState } from 'react'

export default function Page() {
    const [data, setData] = useState({ message: '' })

    useEffect(() => {
        axios.get('/api/hello/backend')
            .then((res) => res.data)
            .then((data) => {
                setData(data)
            })
    }, [])

    return <div>hello {data.message}!</div>
}
```

```bash
$ cd ~/dev/app/frontend/
$ yarn dev
```

ブラウザで http://localhost:3000/hello_backend にアクセスし、「hello backend」と表示されれば成功。

## バックエンドとフロントエンドの連携

### マイグレーションの実施
```bash
(rsl-web) $ cd ~/dev/app/backend/
(rsl-web) $ export DB_USER=rsl
(rsl-web) $ export DB_PASSWORD=chicago
(rsl-web) $ python manage.py migrate --settings config.settings.development
```

PostgreSQLの`app`データベースに下記のテーブルが作成されていれば成功。

```pgsql
app=# \dt
                  List of relations
 Schema |            Name            | Type  | Owner 
--------+----------------------------+-------+-------
 public | auth_group                 | table | rsl
 public | auth_group_permissions     | table | rsl
 public | auth_permission            | table | rsl
 public | auth_user                  | table | rsl
 public | auth_user_groups           | table | rsl
 public | auth_user_user_permissions | table | rsl
 public | django_admin_log           | table | rsl
 public | django_content_type        | table | rsl
 public | django_migrations          | table | rsl
 public | django_session             | table | rsl
(10 rows)
```

### モデルの作成
```bash
(rsl-web) $ cd ~/dev/app/backend/api/
(rsl-web) $ django-admin startapp hello_db
```

`api/hello_db/models.py`を下記のように編集する。

`~/dev/app/backend/api/hello_db/models.py`
```py
from django.db import models

class Hello(models.Model):
    world = models.CharField(max_length=100)

    class Meta:
        db_table = "hello"
```

`base.py`の`INSTALLED_APPS`に`api.hello_db`を追加する。

`~/dev/app/backend/config/settings/base.py`
```py
...（略）...
INSTALLED_APPS = [
...（略）...
    'rest_framework',
    'api.hello_db',               # 追加
]
...（略）...
```

`api/hello_db/apps.py`のアプリケーション名を下記のように編集する。

`~/dev/app/backend/api/hello_db/apps.py`
```py
from django.apps import AppConfig


class HelloDbConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'api.hello_db'    # 修正
```

```bash
(rsl-web) $ cd ~/dev/app/backend/
(rsl-web) $ python manage.py makemigrations --settings config.settings.development
```
